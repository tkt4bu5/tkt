<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
          rel="stylesheet">

    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="fonts/futura/futura.css"/>
    <link rel="stylesheet" type="text/css" href="fonts/mycicero/mycicero.css"/>

    <style>
        .wrapper {
            position: relative;
            padding-top: 15%;
            z-index: 1;
        }

        .top-div {
            position: fixed;
            width: 100%;
            z-index: 2;
        }

        .shadowww {
            background-color: #fff;
            box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 0.4);
        }

    </style>

    <!-- IOS Support -->
    <link rel="apple-touch-icon" href="icons/logo.png">
    <link rel="icon" href="icons/logo.png">
    <meta name="apple-mobile-web-app-status-bar" content=""/>

    <!-- Android Icons -->
    <meta name="msapplication-square70x70logo" content="icons/logo.png" />
<meta name="msapplication-square150x150logo" content="icons/logo.png" />
<meta name="msapplication-wide310x150logo" content="icons/logo.png" />
<meta name="msapplication-square310x310logo" content="icons/logo.png" />

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('service worker registered'))
                .catch(err => console.log('service worker not registered', err))
        }
    </script>
</head>


<body class="font-['Futura']">

<div id="tickets-v2-page" style="display: none">
    <div>
        <div class="grid grid-cols-3 items-center bg-[#CC0033] p-4 rounded-b-xl top-div">
            <div class="col-start-1">
                <img src="backhome.png" alt="Left Image" class="h-8 w-30" id="ticket_list_back_home">
            </div>
            <div class="col-start-2 text-center">
                <p class="text-white font-bold text-l">my tickets</p>
            </div>
            <div class="col-start-3 justify-self-end">
                <img src="person.png" alt="Right Image" class="h-8 ">
            </div>
        </div>
    </div>
    <div class="wrapper">
        <div class="p-4 mt-2">
            <div class="flex justify-between">
                <div>
                    <p class="font-bold">Expired and remaining</p>
                </div>

                <button class="text-right border rounded-lg border-solid border-[#CC0033] flex"
                        style="border-width: 2.5px">
                    <p class="icon_aggiorna text-[#CC0033] p-1"></p>
                    <p class="px-2 font-bold text-[#CC0033] flex"> Refresh</p>

                </button>
            </div>
        </div>
    </div>

    <div class="m-4 ml-4 mr-4 p-4 mx-auto rounded-lg bg-white shadowww">
        <div class="flex justify-between items-center">
            <img class="font-bold text-[#CC0033]" width="30%" src="sita_logo_small.png"></img>
            <img src="icons/chevron-up-outline.svg" class="h-6 mr-2">
        </div>

        <div class="mt-4">
            <p>Active</p>

            <div class="h-full border-2 p-2 rounded-lg">
                <p class="mt-2 font-bold">ABB. MENS. STUDENTE</p>
                <p class="text-xs py-1">PIOVE AUTOST. - PADOVA</p>
                <p class="text-xs py-1">Bought Thu 01/07/2024 11:51</p>

                <div class="flex justify-between mt-2">
                    <button class="border rounded-lg border-solid border-[#CC0033] w-1/2 text-center mx-2 px-2 font-bold text-[#CC0033]"
                            style="border-width: 2.5px">
                        Cancel
                    </button>
                    <button id="show_subscription" class="border rounded-lg border-solid border-[#CC0033] w-1/2 text-center mx-2 px-2 font-bold text-[#CC0033]"
                            style="border-width: 2.5px">
                        See detail
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="ticket_page">

    <div class="relative">
        <div class="grid grid-cols-3 items-center bg-[#CC0033] p-4 rounded-b-xl top-div">
            <div class="col-start-1">
                <img src="backhome.png" alt="Left Image" class="h-8 w-30" id="backhome">
            </div>
            <div class="col-start-2 text-center">
                <p class="text-white font-bold text-l">my tickets</p>
            </div>
            <div class="col-start-3 justify-self-end">
                <img src="person.png" alt="Right Image" class="h-8 ">
            </div>
        </div>
        <div class="wrapper">
            <div class="bg-[#50C79D] p-3 mt-40 mt-[-10px]">
                <div class="pt-3">
                    <p class="text-white text-center font-bold text-xl">TICKET ACTIVE</p>
                </div>
            </div>
        </div>
    </div>

    <div class="m-4 ml-4 mr-4 p-4 mx-auto rounded-lg bg-white shadowww">
        <div class="h-full">
            <div class="flex justify-between">
                <h1 class="font-bold text-[#CC0033] mb-2" style="font-size: 17px">Check and validation</h1>
                <img src="icons/chevron-up-outline.svg" class="h-6">
            </div>
            <!-- NOTE: Sample QR code corresponds to http://mccr.it/vt?t=20052168&v=0735 -->
            <div class="flex justify-center items-center mt-2">
                <div class="text-center">
                    <div id="qr-code" class="h-32 w-32 mx-auto"></div>
                    <!--  g-->
                    <p class="mt-4 text-right font-['Roboto']" style="color: #000;
                font-size: 22px; font-weight: 800; filter: blur(0.2px); text-shadow: 0.14px 0 0.05px blue;">
                        531118564
                    </p>


                    <div class="mt-2 flex justify-center ">
                        <img src="icons/zoom-in.png"
                             style="width: 17px; height: 17px; margin-top: 5px; margin-right: -2px;">
                        <p style="font-size: 18px; font-weight: 400">Zoom</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="time-icon icon_orologio mr-2" style="font-size: 20px;"></span>
                <p class="text-lg" id="timer">18:39:31</p>
            </div>
            <div class="flex items-center">
                <!--Note the number is generated every time-->
                <span class="icon-crc icon_codice_pin text-[#cc0033] mr-2 -mt-1g" style="font-size: 20px"></span>607
            </div>
        </div>
    </div>

    <div class="p-4 ml-2 -mt-2 -mt-4">
        <p class="text-xl font-bold text-[#CC0033] mb-4">ABB. MENS. STUDENTE</p>
        <p class="text-xs">ABB. MENS. STUDENTE</p>
    </div>

    <div class="p-4 m-5 -mt-2 bg-neutral-200 rounded-lg">
        <p class="text-xs -mt-2">Route:</p>
        <p class="text-l -mb-2" id="activate_on">Da: PIOVE AUTOST. to PADOVA</p>
    </div>

    <div class="p-4 m-5 -mt-2 bg-[#50C79D] rounded-lg">
        <div class="flex justify-between">
            <div>
                <p class="text-s -mt-2 -mb-2 text-white">Valid from:</p>
                <p class="text-xl font-medium -mb-2 text-white" id="valid_from"></p>
            </div>

            <div class="text-right">
                <p class="text-s -mb-2 -mt-2 text-white">Valid until:</p>
                <p class="text-xl font-medium -mb-2 text-white" id="valid_until">06/05/2024</p>
            </div>
        </div>
    </div>

    <div class="p-4 m-5 -mt-2 bg-neutral-200 rounded-lg">
        <p class="text-s -m-2">Issued on: <span class="text-l font-bold" id="issued_on">01/07/2024 10:19</span></p>
    </div>

    <div class="m-5 -mt-2 flex justify-between items-center">
        <span class="font-bold text-xl">Price</span>
        <span class="text-[#CC0033] text-2xl font-bold">â‚¬61,60</span>
    </div>


    <div class="m-5 -mt-2 flex justify-between items-center mb-30">
    <span class="">
      <img src="sita_logo_small.png" alt="" srcset="" width="70%">

    </span>
        <span class="text-black text-xl font-bold">#7405/176878</span>
    </div>

    <div class="h-40">

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    function updateTimer() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
    }

    function startCountdown() {
        const timeRemainingElement = document.getElementById('time_remaining');
        let countdownTime = 43 * 60; // 43 minutes in seconds

        function updateTimer() {
            let hours = Math.floor(countdownTime / 3600);
            let minutes = Math.floor((countdownTime % 3600) / 60);
            let seconds = countdownTime % 60;

            timeRemainingElement.textContent = String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');

            if (countdownTime > 0) {
                countdownTime--;
                setTimeout(updateTimer, 1000);
            } else {
                timeRemainingElement.textContent = "00:00:00";
            }
        }

        updateTimer();
    }

    function setDates() {
        const issuedOnElement = document.getElementById('issued_on');
        const now = new Date();
        const firstDayOfMonth = now;
        firstDayOfMonth.setDate(1);

        const randomHour = Math.floor(Math.random() * 11) + 8; // Random hour between 8 and 18
        const randomMinute = Math.floor(Math.random() * 60); // Random minute between 0 and 59

        firstDayOfMonth.setHours(randomHour);
        firstDayOfMonth.setMinutes(randomMinute);
        firstDayOfMonth.setSeconds(0);

        const day = String(firstDayOfMonth.getDate()).padStart(2, '0');
        const month = String(firstDayOfMonth.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = firstDayOfMonth.getFullYear();
        const hours = String(firstDayOfMonth.getHours()).padStart(2, '0');
        const minutes = String(firstDayOfMonth.getMinutes()).padStart(2, '0');

        issuedOnElement.textContent = `${month}/${day}/${year} ${hours}:${minutes}`;

        const validFromElement = document.getElementById('valid_from');

        validFromElement.innerText = `${month}/${day}/${year}`;

        const validUntilElement = document.getElementById('valid_until');
        firstDayOfMonth.setDate(firstDayOfMonth.getDate() + 29);
        const dayEnd = String(firstDayOfMonth.getDate()).padStart(2, '0');
        const monthEnd = String(firstDayOfMonth.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const yearEnd = firstDayOfMonth.getFullYear();
        validUntilElement.innerText = `${monthEnd}/${dayEnd}/${yearEnd}`;
    }

    // Start the countdown and set issued date when the page loads
    window.onload = function () {
        // startCountdown();
        setDates();
    };

    setInterval(updateTimer, 1000);


    function getTicketCode(emissionDate) {
        // Offset in the future to consider for the given emission date to generate the ticket code (to be sure the ticket won't be expired)
        let emissionDateFutureOffsetDays = 2;

        // Given a ticket emission date in epoch time (i.e. seconds from 1/1/1970), approximate the ticket code
        function approximateTicketCode(ticketEmissionDateInEpochTime) {
            // NOTE: the w and b parameters of the line function were interpolated using 2 previous ticket emission dates and codes to estimate the function that relates the ticket emission date and the ticket code
            let w_parameter = 389.0 / 468300.0;
            let b_parameter = -1 * 10901564319.0 / 7805.0;
            let ticketCode = Math.round(w_parameter * ticketEmissionDateInEpochTime + b_parameter);
            return ticketCode;
        }

        let emissionDateFutureOffsetSeconds = emissionDateFutureOffsetDays * 24 * 60 * 60;
        let emission_date_epoch_time = emissionDate.getTime() / 1000;
        let ticket_code = approximateTicketCode(emission_date_epoch_time + emissionDateFutureOffsetSeconds);
        return ticket_code;
    }

    function createQRCode(emissionDate = null) {
        // Get the "#qr-code" element
        let qrCodeElement = $("#qr-code").get(0);
        // Get the pixel width and height of the "#qr-code" element (in pixels)
        let qrCodeWidth = qrCodeElement.clientWidth !== 0 ? qrCodeElement.clientWidth : 200;
        let qrCodeHeight = qrCodeElement.clientHeight !== 0 ? qrCodeElement.clientHeight : 200;
        // Create the QR code
        let t_parameter = "20052167";
        if (emissionDate != null) {
            // Ticket code and emission date of the ticket with the corresponding t parameter
            let sample_ticket_code = 26982;
            // Get the ticket code of the current ticket
            let ticket_code = getTicketCode(emissionDate);
            let tickets_code_difference = ticket_code - sample_ticket_code;
            let new_t_parameter = (parseInt(t_parameter) + tickets_code_difference).toString();
            console.log("New 't' parameter: " + new_t_parameter);
            t_parameter = new_t_parameter;
        }
        let v_parameter = "0009";
        let qr_code_text = "http://mccr.it/vt?t=" + t_parameter + "&v=" + v_parameter;
        console.log("QR code text: " + qr_code_text);
        // Url encoded
        let qrcode = new QRCode(qrCodeElement, {
            text: qr_code_text,
            width: qrCodeWidth,
            height: qrCodeHeight,
            colorDark: "#151515",
            colorLight: "#fff",
            correctLevel: QRCode.CorrectLevel.L
        });

        // Return the QR code
        return qrcode;
    }


    // when backhome is pressed hide ticket_page
    $('#backhome').click(function () {
        $('#ticket_page').hide();
        $('#tickets-v2-page').show();
    });

    $('#show_subscription').click(function () {
        $('#tickets-v2-page').hide();
        $('#ticket_page').show();
    });
    console.log(createQRCode(new Date()))
</script>
</body>

</html>
